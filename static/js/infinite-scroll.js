/** * Infinite Scroll for Photographs Collection * * Provides smooth infinite scrolling functionality for the photographs page * by dynamically loading JSON data chunks as the user scrolls. * * Features: * - Intersection Observer for efficient scroll detection * - Session storage caching for better performance * - Progressive enhancement (works without JS via pagination fallback) * - Error handling with retry logic * - Preloading of next page for seamless experience */ class InfiniteScroll { constructor(options = {}) { // Configuration this.container = options.container || document.querySelector('.photographs-list'); this.sentinel = options.sentinel || document.getElementById('scroll-sentinel'); this.loadingIndicator = options.loadingIndicator || document.getElementById('loading-indicator'); this.paginationElement = options.paginationElement || document.querySelector('.pagination'); // Get initial page number from pagination context const pageInfo = document.querySelector('.page-info'); if (pageInfo) { const pageMatch = pageInfo.textContent.match(/Page (\d+) of (\d+)/); this.currentPage = pageMatch ? parseInt(pageMatch[1]) : 1; this.totalPages = pageMatch ? parseInt(pageMatch[2]) : 1; } else { // No pagination info means we're on a single-page collection this.currentPage = 1; this.totalPages = 1; } // Get collection name from URL or active filter this.collectionName = this.getCollectionName(); // State management this.isLoading = false; this.hasMore = this.currentPage &lt; this.totalPages; this.retryCount = 0; this.maxRetries = 3; this.monthNames = [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ]; // URL configuration this.jsonBasePath = '/photographs/data'; this.siteUrl = this.getSiteUrl(); // Cache for loaded pages this.cache = this.initializeCache(); // Initialize if conditions are met if (this.shouldInitialize()) { this.init(); } } shouldInitialize() { // Don't initialize if we're already on the last page if (!this.hasMore) { return false; } // Don't initialize if required elements are missing if (!this.container || !this.sentinel) { console.warn('InfiniteScroll: Required elements not found'); return false; } return true; } getCollectionName() { // Try to get from URL path const pathParts = window.location.pathname.split('/').filter(p => p); // URL format: /photographs/{collection}/{page}/ if (pathParts.length >= 2 && pathParts[0] === 'photographs') { // If second part is a number, we're at /photographs/{page}/ which means "all" if (!isNaN(pathParts[1])) { return 'all'; } return pathParts[1]; } // Fallback to "all" collection return 'all'; } getSiteUrl() { // Get site URL from the page (look for existing links) const link = document.querySelector('a[href*="/photographs/"]'); if (link) { const url = new URL(link.href); return url.origin; } return window.location.origin; } initializeCache() { // Use sessionStorage for caching JSON responses try { const cacheKey = `photos_cache_${this.collectionName}`; const cached = sessionStorage.getItem(cacheKey); return cached ? JSON.parse(cached) : {}; } catch (e) { console.warn('InfiniteScroll: Cache initialization failed', e); return {}; } } saveToCache(page, data) { try { this.cache[page] = data; const cacheKey = `photos_cache_${this.collectionName}`; sessionStorage.setItem(cacheKey, JSON.stringify(this.cache)); } catch (e) { console.warn('InfiniteScroll: Cache save failed', e); } } init() { // Set up intersection observer this.setupIntersectionObserver(); // Preload next page for better UX this.preloadNextPage(); } setupIntersectionObserver() { // Create intersection observer with optimized settings const observerOptions = { root: null, // viewport rootMargin: '400px', // Start loading before user reaches the bottom threshold: 0.01 }; this.observer = new IntersectionObserver( (entries) => this.handleIntersection(entries), observerOptions ); // Start observing the sentinel if (this.sentinel) { this.observer.observe(this.sentinel); } } handleIntersection(entries) { entries.forEach(entry => { if (entry.isIntersecting && !this.isLoading && this.hasMore) { this.loadNextPage(); } }); } async loadNextPage() { if (this.isLoading || !this.hasMore) { return; } this.isLoading = true; this.showLoader(); const nextPage = this.currentPage + 1; try { // Check cache first let data; if (this.cache[nextPage]) { data = this.cache[nextPage]; } else { data = await this.fetchPage(nextPage); this.saveToCache(nextPage, data); } // Render the photos this.renderPhotos(data); // Update state this.currentPage = nextPage; this.hasMore = data.has_next; this.retryCount = 0; // Preload next page if available if (this.hasMore) { this.preloadNextPage(); } } catch (error) { console.error('InfiniteScroll: Error loading page', error); this.handleError(error); } finally { this.isLoading = false; this.hideLoader(); } } async fetchPage(pageNum) { const url = `${this.siteUrl}${this.jsonBasePath}/${this.collectionName}/page-${pageNum}.json`; const response = await fetch(url); if (!response.ok) { throw new Error(`HTTP ${response.status}: ${response.statusText}`); } const data = await response.json(); return data; } async preloadNextPage() { // Preload next page in background for seamless experience const nextPage = this.currentPage + 1; if (nextPage > this.totalPages || this.cache[nextPage]) { return; // Already cached or doesn't exist } try { const data = await this.fetchPage(nextPage); this.saveToCache(nextPage, data); } catch (error) { console.warn('InfiniteScroll: Preload failed (non-critical)', error); } } renderPhotos(data) { if (!data.photos || data.photos.length === 0) { console.warn('InfiniteScroll: No photos to render'); return; } const fragment = document.createDocumentFragment(); data.photos.forEach(photo => { const photoElement = this.createPhotoElement(photo); fragment.appendChild(photoElement); }); // Add new photos before the sentinel this.container.appendChild(fragment); // Trigger fade-in animation requestAnimationFrame(() => { const newPhotos = this.container.querySelectorAll('.photo-item.loading'); newPhotos.forEach(photo => { photo.classList.remove('loading'); photo.classList.add('loaded'); }); }); } createPhotoElement(photo) { // Create the photo container div const photoDiv = document.createElement('div'); photoDiv.setAttribute('data-collection', photo.collection); photoDiv.id = photo.slug; photoDiv.className = 'photo-item loading'; // Create the grid container const gridDiv = document.createElement('div'); gridDiv.className = 'photographs-grid'; // Create image column const imageColumn = document.createElement('div'); const imageLink = document.createElement('a'); imageLink.href = photo.url; const picture = document.createElement('picture'); // WebP source const webpSource = document.createElement('source'); webpSource.srcset = photo.images.display; webpSource.type = 'image/webp'; picture.appendChild(webpSource); // Fallback image with lazy loading const img = document.createElement('img'); img.src = photo.images.display_fallback; img.alt = photo.title; img.className = 'clickable-image'; img.loading = 'lazy'; if (photo.images && photo.images.display_width && photo.images.display_height) { img.setAttribute('width', photo.images.display_width); img.setAttribute('height', photo.images.display_height); } picture.appendChild(img); imageLink.appendChild(picture); imageColumn.appendChild(imageLink); // Create detail column const detailColumn = document.createElement('div'); detailColumn.className = 'detail-info'; // Title const title = document.createElement('h3'); const titleLink = document.createElement('a'); titleLink.href = photo.url; const titleSpan = document.createElement('span'); titleSpan.className = 'image-title'; titleSpan.textContent = photo.title; titleLink.appendChild(titleSpan); title.appendChild(titleLink); detailColumn.appendChild(title); const metadataSection = this.buildMetadataSection(photo); if (metadataSection) { detailColumn.appendChild(metadataSection); } // Buttons const buttonsDiv = document.createElement('div'); buttonsDiv.className = 'button-row'; const moreInfoBtn = document.createElement('a'); moreInfoBtn.href = photo.url; moreInfoBtn.className = 'btn'; moreInfoBtn.textContent = 'More Info'; buttonsDiv.appendChild(moreInfoBtn); if (photo.shop_enabled && photo.shop_url) { const shopBtn = document.createElement('a'); shopBtn.href = photo.shop_url; shopBtn.className = 'btn'; shopBtn.textContent = 'Shop Print'; buttonsDiv.appendChild(shopBtn); } detailColumn.appendChild(buttonsDiv); // Assemble the grid gridDiv.appendChild(imageColumn); gridDiv.appendChild(detailColumn); photoDiv.appendChild(gridDiv); return photoDiv; } buildMetadataSection(photo) { const metadataItems = []; const photographedText = this.getPhotographedText(photo); if (photographedText) { metadataItems.push(photographedText); } if (photo.location) { metadataItems.push(photo.location); } if (!metadataItems.length) { return null; } const metadataDiv = document.createElement('div'); metadataDiv.className = 'image-metadata'; metadataItems.forEach(text => { const list = document.createElement('ul'); const listItem = document.createElement('li'); listItem.textContent = text; list.appendChild(listItem); metadataDiv.appendChild(list); }); return metadataDiv; } getPhotographedText(photo) { const metadata = photo.metadata || {}; const rawDate = metadata.date_photographed || photo.date; const formattedDate = this.formatPhotographDate(rawDate); if (!formattedDate) { return ''; } return `Photographed ${formattedDate}`; } formatPhotographDate(dateString) { const parsed = this.parseDateString(dateString); if (!parsed) { return ''; } const { year, month } = parsed; if (typeof month === 'number') { const monthName = this.monthNames[month]; if (!monthName) { return ''; } return `${monthName} ${year}`; } return `${year}`; } parseDateString(dateString) { if (!dateString || typeof dateString !== 'string') { return null; } const trimmed = dateString.trim(); if (!trimmed) { return null; } const match = trimmed.match(/^(\d{4})(?:-(\d{2}))?/); if (!match) { return null; } const year = parseInt(match[1], 10); if (Number.isNaN(year)) { return null; } if (!match[2]) { return { year, month: null }; } const month = parseInt(match[2], 10); if (Number.isNaN(month) || month &lt; 1 || month > 12) { return null; } return { year, month: month - 1 }; } showLoader() { if (this.loadingIndicator) { this.loadingIndicator.style.display = 'block'; } } hideLoader() { if (this.loadingIndicator) { this.loadingIndicator.style.display = 'none'; } } handleError(error) { this.hideLoader(); // Retry logic if (this.retryCount &lt; this.maxRetries) { this.retryCount++; setTimeout(() => { this.isLoading = false; this.loadNextPage(); }, 1000 * this.retryCount); // Exponential backoff } else { // Show error message this.showErrorMessage(error); // Re-show pagination as fallback if (this.paginationElement) { this.paginationElement.style.display = 'block'; } } } showErrorMessage(error) { const errorDiv = document.createElement('div'); errorDiv.className = 'infinite-scroll-error'; errorDiv.innerHTML = ` <p>Unable to load more photographs. Please try refreshing the page.<p class=error-details>${error.message}</p> `; if (this.sentinel) { this.sentinel.parentNode.insertBefore(errorDiv, this.sentinel); } } } // Initialize on page load document.addEventListener('DOMContentLoaded', function() { // Only initialize on photographs collection pages if (window.location.pathname.includes('/photographs/')) { // Check if we have the required elements const container = document.querySelector('.photographs-list'); const sentinel = document.getElementById('scroll-sentinel'); if (container && sentinel) { window.photographsInfiniteScroll = new InfiniteScroll(); } } });